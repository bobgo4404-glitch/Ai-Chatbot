<!DOCTYPE html>
<html lang="ko" translate="no" class="notranslate">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>유진테크놀로지 AI 챗봇</title>
    <meta name="google" content="notranslate">

    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: { 50: '#eef2ff', 100: '#e0e7ff', 500: '#6366f1', 600: '#4f46e5', 700: '#4338ca', 900: '#312e81' },
                        accent: { 400: '#a78bfa', 500: '#8b5cf6', 600: '#7c3aed' },
                        dark: { 800: '#1e293b', 900: '#0f172a' }
                    },
                    fontFamily: { sans: ['Pretendard', 'Noto Sans KR', 'sans-serif'] },
                    boxShadow: {
                        'glass': '0 8px 32px 0 rgba(31, 38, 135, 0.15)',
                        'glow': '0 0 15px rgba(99, 102, 241, 0.5)',
                    },
                    animation: {
                        'float': 'float 6s ease-in-out infinite',
                        'slide-up': 'slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1)',
                        'fade-in': 'fadeIn 0.3s ease-out',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'typing': 'typing 1.4s infinite ease-in-out both', // [New] 부드러운 타이핑 애니메이션
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-5px)' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(40px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'scale(0.95)' },
                            '100%': { opacity: '1', transform: 'scale(1)' },
                        },
                        // [New] 타이핑 효과 키프레임 추가
                        typing: {
                            '0%, 80%, 100%': { transform: 'translateY(0)', opacity: '0.6' },
                            '40%': { transform: 'translateY(-8px)', opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>

    <!-- 2. Fonts & Icons -->
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- 3. React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <!-- 4. Babel -->
    <script src="https://unpkg.com/@babel/standalone@7.23.5/babel.min.js"></script>

    <!-- 5. PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>

    <!-- 6. Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- 7. Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, setDoc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        window.GEMINI_API_KEY = ""; 

        const firebaseConfig = {
            apiKey: "AIzaSyC-RSVwKZ1Qddohg3UP5Cp3Bl-vz5D0Go8",
            authDomain: "visitors-manager.firebaseapp.com",
            projectId: "visitors-manager",
            storageBucket: "visitors-manager.firebasestorage.app",
            messagingSenderId: "567674691771",
            appId: "1:567674691771:web:c46ed8d52ef587213f899e",
            measurementId: "G-VXMJ0Y7KQJ"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        window.db = db;
        window.auth = auth;
        window.firebaseImports = { 
            signInAnonymously, onAuthStateChanged, collection, addDoc, 
            query, orderBy, onSnapshot, serverTimestamp, doc, setDoc, deleteDoc, getDoc 
        };
    </script>

    <style>
        body { font-family: 'Pretendard', sans-serif; margin: 0; padding: 0; overflow-x: hidden; background-color: transparent; }
        .glass-panel {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .chat-scroll::-webkit-scrollbar { width: 4px; }
        .chat-scroll::-webkit-scrollbar-track { background: transparent; }
        .chat-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .message-bubble-user {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- Components ---

        class ErrorBoundary extends React.Component {
            constructor(props) { super(props); this.state = { hasError: false }; }
            static getDerivedStateFromError(error) { return { hasError: true }; }
            componentDidCatch(error, errorInfo) { console.error("Uncaught error:", error, errorInfo); }
            render() {
                if (this.state.hasError) {
                    return (
                        <div className="fixed bottom-4 right-4 bg-white/90 backdrop-blur-md p-6 rounded-2xl shadow-glass border border-red-100 z-[100] w-80 animate-fade-in">
                            <h2 className="text-lg font-bold text-red-600 mb-2">시스템 오류</h2>
                            <button onClick={() => window.location.reload()} className="w-full bg-red-50 text-red-600 py-2 rounded-xl text-sm font-medium">새로고침</button>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        const Icon = ({ name, className = "" }) => {
            const ref = React.useRef(null);
            React.useEffect(() => {
                if (ref.current) {
                    ref.current.innerHTML = `<i data-lucide="${name}" class="${className}"></i>`;
                    if (window.lucide && window.lucide.createIcons) window.lucide.createIcons({ root: ref.current });
                }
            }, [name, className]);
            return <span ref={ref} style={{ display: 'inline-flex', verticalAlign: 'middle' }} />;
        };

        // [수정] 색상을 정의된 primary-600(진한 인디고/파랑)으로 변경하여 가시성 확보
        const LoadingSpinner = () => (
            <div className="flex items-center space-x-1.5 p-1">
                <div className="w-2.5 h-2.5 bg-primary-600 rounded-full animate-typing" style={{ animationDelay: '0ms' }}></div>
                <div className="w-2.5 h-2.5 bg-primary-600 rounded-full animate-typing" style={{ animationDelay: '200ms' }}></div>
                <div className="w-2.5 h-2.5 bg-primary-600 rounded-full animate-typing" style={{ animationDelay: '400ms' }}></div>
            </div>
        );

        // --- Improved Gemini Logic ---

        const validateAndGetBestModel = async (apiKey) => {
            let candidates = [];
            try {
                const listResponse = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`);
                if (listResponse.ok) {
                    const data = await listResponse.json();
                    if (data.models) {
                        candidates = data.models
                            .filter(m => m.supportedGenerationMethods && m.supportedGenerationMethods.includes("generateContent"))
                            .map(m => m.name.replace("models/", ""));
                    }
                }
            } catch (e) { console.warn("ListModels API failed. Switching to manual list."); }

            if (candidates.length === 0) {
                candidates = ["gemini-1.5-flash", "gemini-1.5-flash-latest", "gemini-1.5-pro", "gemini-1.0-pro", "gemini-pro"];
            }

            candidates.sort((a, b) => {
                const aIsFlash = a.includes("flash");
                const bIsFlash = b.includes("flash");
                if (aIsFlash && !bIsFlash) return -1;
                if (!aIsFlash && bIsFlash) return 1;
                return 0;
            });

            for (const model of candidates) {
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
                        method: "POST", headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ contents: [{ parts: [{ text: "Hello" }] }] })
                    });
                    const data = await response.json();
                    if (response.ok && data.candidates && data.candidates.length > 0) {
                        console.log(`✅ BEST MODEL FOUND: ${model}`);
                        return model;
                    }
                } catch (err) { console.warn(`❌ ${model} failed:`, err); }
            }
            throw new Error("유효한 모델을 찾을 수 없습니다. (할당량 초과 또는 키 오류)");
        };

        const callGeminiAI = async (prompt, apiKey, preferredModel, knowledgeData) => {
            const systemPrompt = `
                [역할]
                당신은 '유진테크놀로지(Yujintechnology)'의 AI 어시스턴트입니다. 아래 제공된 [사내 지식 데이터베이스]를 기반으로 임직원의 질문에 답변하세요.
                
                [답변 스타일 가이드 - 필수 준수]
                1. **특수문자 금지**: 답변 텍스트 내에 강조를 위한 별표('*') 기호를 절대 사용하지 마십시오. 마크다운 볼드체(**텍스트**)나 리스트(*) 문법을 사용하면 안 됩니다.
                2. **리스트 작성법**: 리스트가 필요할 경우 반드시 숫자(1., 2.) 또는 하이픈(-) 기호를 사용하세요.
                3. **강조 방법**: 중요한 단어는 홑따옴표(' ')나 대괄호([ ])를 사용하여 표시하세요. (예: '휴게시간'은...)
                
                [사내 지식 데이터베이스]
                ${knowledgeData || "(등록된 데이터 없음)"}
            `;

            const candidates = [preferredModel, "gemini-1.5-flash", "gemini-1.5-pro"];
            const uniqueModels = [...new Set(candidates.filter(Boolean))];
            
            let lastError = null;

            for (const model of uniqueModels) {
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
                        method: "POST", headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ contents: [{ parts: [{ text: systemPrompt + "\n\nUser Question: " + prompt }] }] })
                    });
                    const data = await response.json();
                    if (data.error) {
                        lastError = new Error(data.error.message);
                        continue; 
                    }
                    return data.candidates[0].content.parts[0].text;
                } catch (error) { lastError = error; }
            }
            throw lastError || new Error("AI 응답을 받아올 수 없습니다.");
        };

        // --- Chart Analysis Component ---
        const LogAnalysisChart = ({ logs }) => {
            React.useEffect(() => {
                if (!logs || logs.length === 0) return;

                const categories = { '근태/휴가': 0, '복지/급여': 0, 'IT/시스템': 0, '일반/기타': 0 };
                const keywords = {
                    '근태/휴가': ['연차', '휴가', '반차', '지각', '출근', '퇴근', '근무', '시간', '조퇴'],
                    '복지/급여': ['급여', '월급', '연봉', '식대', '복지', '포인트', '경조사', '보너스'],
                    'IT/시스템': ['컴퓨터', '노트북', '인터넷', '계정', '비밀번호', '메일', '그룹웨어', '네트워크']
                };

                logs.forEach(log => {
                    let matched = false;
                    for (const [cat, words] of Object.entries(keywords)) {
                        if (words.some(w => log.question.includes(w))) {
                            categories[cat]++;
                            matched = true;
                            break;
                        }
                    }
                    if (!matched) categories['일반/기타']++;
                });

                const hours = new Array(24).fill(0);
                logs.forEach(log => {
                    let date;
                    if (log.timestamp && typeof log.timestamp === 'object' && log.timestamp.seconds) {
                        date = new Date(log.timestamp.seconds * 1000);
                    } else {
                        date = new Date(log.timestamp);
                    }
                    
                    if (!isNaN(date.getTime())) {
                        hours[date.getHours()]++;
                    }
                });

                const existingDonut = Chart.getChart("donutCanvas");
                if (existingDonut) existingDonut.destroy();
                const existingLine = Chart.getChart("lineCanvas");
                if (existingLine) existingLine.destroy();

                const ctxDonut = document.getElementById('donutCanvas').getContext('2d');
                new Chart(ctxDonut, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(categories),
                        datasets: [{
                            data: Object.values(categories),
                            backgroundColor: ['#6366f1', '#a855f7', '#ec4899', '#94a3b8'],
                            borderWidth: 0
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
                });

                const ctxLine = document.getElementById('lineCanvas').getContext('2d');
                const timeLabels = Array.from({length: 24}, (_, i) => `${i}시`);

                new Chart(ctxLine, {
                    type: 'line',
                    data: {
                        labels: timeLabels,
                        datasets: [{
                            label: '시간대별 질문 수',
                            data: hours,
                            borderColor: '#4f46e5',
                            backgroundColor: 'rgba(79, 70, 229, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false, 
                        scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } 
                    }
                });

            }, [logs]);

            return (
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6 h-full">
                    <div className="bg-white p-6 rounded-3xl border border-slate-100 shadow-sm flex flex-col">
                        <h4 className="font-bold text-slate-700 mb-4 flex items-center"><Icon name="pie-chart" className="w-4 h-4 mr-2" />질문 유형 분석</h4>
                        <div className="flex-1 relative min-h-[250px]">
                            <canvas id="donutCanvas"></canvas>
                        </div>
                    </div>
                    <div className="bg-white p-6 rounded-3xl border border-slate-100 shadow-sm flex flex-col">
                        <h4 className="font-bold text-slate-700 mb-4 flex items-center"><Icon name="activity" className="w-4 h-4 mr-2" />시간대별 이용 추이</h4>
                        <div className="flex-1 relative min-h-[250px]">
                            <canvas id="lineCanvas"></canvas>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Main Components ---

        const ChatWidget = ({ user, globalApiKey, globalModelName, knowledgeItems, onClose, onOpenAdmin }) => {
            const [messages, setMessages] = React.useState([
                { id: 'welcome', text: "안녕하세요! 유진테크놀로지 AI입니다.\n사내 규정 및 업무 관련 궁금한 점을 물어보세요.", sender: 'ai' }
            ]);
            const [input, setInput] = React.useState("");
            const [isLoading, setIsLoading] = React.useState(false);
            const messagesEndRef = React.useRef(null);
            
            const { collection, addDoc, serverTimestamp } = window.firebaseImports;
            const db = window.db;

            React.useEffect(() => { messagesEndRef.current?.scrollIntoView({ behavior: "smooth" }); }, [messages]);

            const handleSend = async (e) => {
                e.preventDefault();
                const userMsg = input.trim();
                if (!userMsg || isLoading) return;

                if (userMsg === "!admin") {
                    setInput("");
                    onOpenAdmin(); 
                    return;
                }

                setInput("");
                const newMessages = [...messages, { id: Date.now(), text: userMsg, sender: 'user' }];
                setMessages(newMessages);
                setIsLoading(true);

                try {
                    let aiResponseText = "";
                    if (!globalApiKey) {
                        aiResponseText = "⚠️ 관리자 설정이 필요합니다.\n(!admin 명령어로 관리자 모드 접속)";
                    } else {
                        const fullKnowledge = knowledgeItems.map(item => `[문서: ${item.title}]\n${item.content}`).join("\n\n");
                        aiResponseText = await callGeminiAI(userMsg, globalApiKey, globalModelName, fullKnowledge);
                        
                        await addDoc(collection(db, "chat_logs"), {
                            userId: user.uid,
                            question: userMsg,
                            answer: aiResponseText,
                            timestamp: new Date().toISOString(), 
                            category: "widget_chat"
                        });
                    }
                    setMessages(prev => [...prev, { id: Date.now() + 1, text: aiResponseText, sender: 'ai' }]);
                } catch (error) {
                    setMessages(prev => [...prev, { id: Date.now() + 1, text: "오류가 발생했습니다.", sender: 'ai', isError: true }]);
                } finally {
                    setIsLoading(false);
                }
            };

            return (
                <div className="fixed bottom-6 right-6 md:bottom-24 md:right-8 w-full md:w-[420px] h-[85vh] md:h-[650px] glass-panel rounded-[2rem] shadow-glass flex flex-col overflow-hidden animate-slide-up z-50 ring-1 ring-white/50">
                    <div className="bg-gradient-to-r from-primary-900 via-primary-700 to-accent-600 p-5 flex justify-between items-center text-white relative overflow-hidden shrink-0">
                        <div className="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full blur-2xl -mr-10 -mt-10"></div>
                        <div className="flex items-center space-x-4 relative z-10">
                            <div className="bg-white/20 p-2.5 rounded-2xl backdrop-blur-sm border border-white/10 shadow-lg">
                                <Icon name="bot" className="w-6 h-6 text-white" />
                            </div>
                            <div>
                                <h3 className="font-bold text-lg tracking-wide">Yujintechnology AI</h3>
                                <div className="flex items-center space-x-2">
                                    <span className={`w-2 h-2 rounded-full ${globalApiKey ? 'bg-green-400 shadow-[0_0_8px_rgba(74,222,128,0.8)]' : 'bg-red-400'}`}></span>
                                    <p className="text-xs text-primary-100 font-medium">{globalApiKey ? '연결됨' : '연결 끊김'}</p>
                                </div>
                            </div>
                        </div>
                        <button onClick={onClose} className="relative z-10 p-2 hover:bg-white/20 rounded-full transition duration-300 md:hidden">
                            <Icon name="x" className="w-6 h-6" />
                        </button>
                    </div>

                    <div className="flex-1 overflow-y-auto p-5 bg-gradient-to-b from-primary-50/50 to-white/50 chat-scroll">
                        {messages.map((msg) => (
                            <div key={msg.id} className={`flex w-full mb-6 ${msg.sender === 'user' ? 'justify-end' : 'justify-start'} animate-fade-in`}>
                                <div className={`flex max-w-[85%] ${msg.sender === 'user' ? 'flex-row-reverse' : 'flex-row items-end'}`}>
                                    {msg.sender === 'ai' && (
                                        <div className="w-8 h-8 bg-white rounded-full flex items-center justify-center mr-2 shadow-sm border border-primary-100 shrink-0 mb-1">
                                            <Icon name="sparkles" className="w-4 h-4 text-accent-500" />
                                        </div>
                                    )}
                                    <div className={`px-5 py-3.5 text-[0.95rem] leading-relaxed shadow-sm backdrop-blur-sm ${
                                        msg.sender === 'user' 
                                            ? 'message-bubble-user text-white rounded-[1.5rem] rounded-tr-sm' 
                                            : 'bg-white/90 text-slate-700 border border-white/50 rounded-[1.5rem] rounded-tl-sm shadow-md'
                                    } ${msg.isError ? 'bg-red-50 border-red-200 text-red-600' : ''}`}>
                                        {msg.text}
                                    </div>
                                </div>
                            </div>
                        ))}
                        {isLoading && (
                            <div className="flex justify-start mb-4 pl-12">
                                <div className="bg-white/80 px-4 py-3 rounded-2xl border border-primary-100 shadow-sm">
                                    <LoadingSpinner />
                                </div>
                            </div>
                        )}
                        <div ref={messagesEndRef} />
                    </div>

                    <div className="p-4 bg-white/80 backdrop-blur-xl border-t border-primary-100 shrink-0">
                        <form onSubmit={handleSend} className="relative group">
                            <input
                                type="text"
                                value={input}
                                onChange={(e) => setInput(e.target.value)}
                                placeholder="질문을 입력하세요..."
                                className="w-full bg-slate-50 text-slate-800 rounded-full py-4 pl-6 pr-14 text-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:bg-white transition-all shadow-inner border border-slate-200"
                                disabled={isLoading}
                            />
                            <button 
                                type="submit" 
                                disabled={isLoading || !input.trim()}
                                className={`absolute right-2 top-2 p-2.5 rounded-full transition-all duration-300 ${
                                    input.trim() 
                                        ? 'bg-gradient-to-r from-primary-600 to-accent-600 text-white shadow-lg hover:scale-105 hover:shadow-glow' 
                                        : 'bg-slate-200 text-slate-400'
                                }`}
                            >
                                <Icon name="arrow-up" className="w-5 h-5" />
                            </button>
                        </form>
                        <div className="text-center mt-3 flex justify-center items-center space-x-1 opacity-60">
                             <Icon name="zap" className="w-3 h-3 text-accent-500" />
                             <span className="text-[10px] text-slate-400 font-medium tracking-wide">POWERED BY YUJIN AI SYSTEM</span>
                        </div>
                    </div>
                </div>
            );
        };

        const AdminOverlay = ({ onClose, onSetGlobalKey, knowledgeItems, onAddKnowledge, onDeleteKnowledge, currentKey }) => {
            const [isAuthenticated, setIsAuthenticated] = React.useState(false);
            const [password, setPassword] = React.useState("");
            const [activeTab, setActiveTab] = React.useState('settings');
            
            const [apiKeyInput, setApiKeyInput] = React.useState(currentKey || "");
            const [isCheckingKey, setIsCheckingKey] = React.useState(false);
            const [statusMsg, setStatusMsg] = React.useState("");

            const [manualTitle, setManualTitle] = React.useState("");
            const [manualContent, setManualContent] = React.useState("");
            const [isUploading, setIsUploading] = React.useState(false);
            const [logs, setLogs] = React.useState([]);

            const { collection, query, orderBy, onSnapshot, doc, setDoc } = window.firebaseImports;
            const db = window.db;

            const handleLogin = (e) => {
                e.preventDefault();
                if (password === "0908") {
                    setIsAuthenticated(true);
                    const q = query(collection(db, "chat_logs"), orderBy("timestamp", "desc"));
                    onSnapshot(q, (snapshot) => {
                        setLogs(snapshot.docs.map(doc => {
                            const data = doc.data();
                            let displayTs = "날짜 없음";
                            const ts = data.timestamp;

                            if (ts) {
                                if (typeof ts === 'string') {
                                    const d = new Date(ts);
                                    displayTs = !isNaN(d.getTime()) ? d.toLocaleString() : ts;
                                } else if (ts.seconds !== undefined) {
                                    displayTs = new Date(ts.seconds * 1000).toLocaleString();
                                } else if (typeof ts.toDate === 'function') {
                                    displayTs = ts.toDate().toLocaleString();
                                }
                            }

                            return { 
                                id: doc.id, 
                                ...data, 
                                timestamp: ts, 
                                displayTimestamp: displayTs 
                            };
                        }));
                    });
                } else {
                    alert("비밀번호가 일치하지 않습니다.");
                    setPassword("");
                }
            };

            const handleSaveKey = async () => {
                if (!apiKeyInput.trim()) return;
                setIsCheckingKey(true);
                setStatusMsg("모델 연결 테스트 중...");
                
                try {
                    const modelName = await validateAndGetBestModel(apiKeyInput);
                    await setDoc(doc(db, "settings", "api_config"), { apiKey: apiKeyInput, modelName: modelName, updatedAt: new Date() }, { merge: true });
                    onSetGlobalKey(apiKeyInput, modelName); 
                    setStatusMsg(`✅ 연결 성공! (${modelName}) - 자동 저장됨`);
                } catch (error) {
                    console.error(error);
                    setStatusMsg(`❌ 연결 실패: ${error.message}`);
                } finally {
                    setIsCheckingKey(false);
                }
            };

            const handleAddManual = async () => {
                if(!manualTitle.trim() || !manualContent.trim()) { alert("입력값을 확인해주세요."); return; }
                await onAddKnowledge({ title: manualTitle, content: manualContent, type: 'manual' });
                setManualTitle(""); setManualContent(""); alert("등록되었습니다.");
            };

            const handleFileUpload = async (e) => {
                const file = e.target.files[0];
                if (!file || file.type !== 'application/pdf') { alert("PDF만 가능합니다."); return; }
                setIsUploading(true);
                try {
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                    let fullText = "";
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const tc = await page.getTextContent();
                        fullText += tc.items.map(item => item.str).join(" ") + "\n";
                    }
                    if (!fullText.trim()) throw new Error("텍스트 없음");
                    await onAddKnowledge({ title: file.name, content: fullText, type: 'pdf' });
                    alert("업로드 완료!");
                } catch (err) { alert("오류: " + err.message); } 
                finally { setIsUploading(false); e.target.value = ''; }
            };

            const downloadCSV = () => {
                const csvContent = ["ID,Time,Question,Answer\n" + logs.map(l => `${l.id},"${l.displayTimestamp}","${l.question.replace(/"/g,'""')}","${l.answer.replace(/"/g,'""')}"`).join("\n")];
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob); const a = document.createElement("a"); a.href = url; a.download = "report.csv"; a.click();
            };

            return (
                <div className="fixed inset-0 bg-dark-900/80 z-[100] flex items-center justify-center p-4 backdrop-blur-md animate-fade-in">
                    <div className="bg-white w-full max-w-5xl h-[85vh] rounded-[2rem] shadow-2xl flex flex-col overflow-hidden border border-white/20">
                        <div className="p-6 border-b border-slate-100 flex justify-between items-center bg-white sticky top-0 z-10">
                            <h2 className="text-xl font-bold text-slate-800 flex items-center tracking-tight">
                                <div className="p-2 bg-primary-100 rounded-lg mr-3">
                                    <Icon name="shield-check" className="w-5 h-5 text-primary-600" />
                                </div>
                                관리자 대시보드
                            </h2>
                            <button onClick={onClose} className="p-2 hover:bg-slate-100 rounded-full transition text-slate-400 hover:text-slate-600">
                                <Icon name="x" className="w-6 h-6" />
                            </button>
                        </div>

                        <div className="flex-1 overflow-hidden flex flex-col bg-slate-50">
                            {!isAuthenticated ? (
                                <div className="flex flex-col items-center justify-center h-full animate-fade-in">
                                    <div className="w-20 h-20 bg-white rounded-3xl flex items-center justify-center mb-6 shadow-xl shadow-primary-500/10 animate-float">
                                        <Icon name="lock" className="w-8 h-8 text-primary-600" />
                                    </div>
                                    <h3 className="text-2xl font-bold mb-2 text-slate-800">관리자 보안 접속</h3>
                                    <p className="text-slate-500 mb-8">관리자 비밀번호를 입력하세요.</p>
                                    <form onSubmit={handleLogin} className="flex flex-col gap-4 w-80">
                                        <div className="relative group">
                                            <input type="password" value={password} onChange={(e) => setPassword(e.target.value)}
                                                placeholder="비밀번호 입력" className="w-full p-4 pl-12 border border-slate-200 rounded-xl outline-none text-center bg-white shadow-sm focus:ring-2 focus:ring-primary-500 transition-all" />
                                            <div className="absolute left-4 top-4 text-slate-300 group-focus-within:text-primary-500 transition-colors"><Icon name="key" className="w-5 h-5" /></div>
                                        </div>
                                        <button type="submit" className="bg-gradient-to-r from-primary-600 to-accent-600 text-white py-4 rounded-xl font-bold shadow-lg shadow-primary-600/30 hover:shadow-xl hover:scale-[1.02] transition-all">관리자 모드 진입</button>
                                    </form>
                                </div>
                            ) : (
                                <div className="flex flex-col h-full">
                                    <div className="flex border-b border-slate-200 bg-white px-8 gap-8">
                                        {[
                                            { id: 'settings', label: '시스템 설정' },
                                            { id: 'knowledge', label: '지식 데이터 관리' },
                                            { id: 'logs', label: '대화 로그' },
                                            { id: 'analysis', label: '데이터 분석' }
                                        ].map(tab => (
                                            <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`py-5 font-bold text-sm border-b-2 transition-all ${activeTab === tab.id ? 'border-primary-600 text-primary-600' : 'border-transparent text-slate-400 hover:text-slate-600'}`}>
                                                {tab.label}
                                            </button>
                                        ))}
                                    </div>

                                    <div className="flex-1 overflow-y-auto p-8">
                                        {activeTab === 'settings' && (
                                            <div className="bg-white p-8 rounded-3xl border border-slate-100 shadow-sm max-w-2xl mx-auto animate-fade-in">
                                                <h3 className="font-bold text-lg text-slate-800 mb-6 flex items-center"><Icon name="cpu" className="w-5 h-5 mr-3 text-primary-500" /> AI 모델 연동 설정</h3>
                                                <div className="space-y-4">
                                                    <div>
                                                        <label className="text-xs font-bold text-slate-500 mb-2 block uppercase tracking-wider">Google AI Studio API 키</label>
                                                        <div className="flex gap-3">
                                                            <input type="password" value={apiKeyInput} onChange={(e) => setApiKeyInput(e.target.value)}
                                                                placeholder="AIza로 시작하는 키를 입력하세요" className="flex-1 p-3 border border-slate-200 rounded-xl outline-none text-sm font-mono focus:border-primary-500 focus:ring-2 focus:ring-primary-500/20 transition-all" />
                                                            <button onClick={handleSaveKey} disabled={isCheckingKey || !apiKeyInput}
                                                                className={`px-6 rounded-xl text-sm font-bold text-white transition-all shadow-lg ${isCheckingKey ? 'bg-slate-400' : 'bg-primary-600 hover:bg-primary-700 hover:shadow-primary-600/30'}`}>
                                                                {isCheckingKey ? '확인 중...' : '연결 및 저장'}
                                                            </button>
                                                        </div>
                                                        <p className={`text-sm mt-3 font-medium flex items-center ${statusMsg.includes('실패') ? 'text-red-500' : 'text-green-600'}`}>
                                                            {statusMsg && (statusMsg.includes('실패') ? <Icon name="alert-circle" className="w-4 h-4 mr-1"/> : <Icon name="check-circle" className="w-4 h-4 mr-1"/>)}
                                                            {statusMsg}
                                                        </p>
                                                    </div>
                                                </div>
                                            </div>
                                        )}

                                        {activeTab === 'knowledge' && (
                                            <div className="grid grid-cols-1 lg:grid-cols-3 gap-8 h-full">
                                                <div className="lg:col-span-1 space-y-6">
                                                    <div className="bg-white p-6 rounded-3xl border border-slate-100 shadow-sm">
                                                        <h3 className="font-bold text-slate-800 mb-4 flex items-center"><Icon name="file-plus" className="w-4 h-4 mr-2" /> 지식 추가 (직접 입력)</h3>
                                                        <input type="text" value={manualTitle} onChange={(e) => setManualTitle(e.target.value)} placeholder="제목 (예: 2026년 연차 규정)" className="w-full p-3 bg-slate-50 rounded-xl mb-3 text-sm outline-none border border-transparent focus:bg-white focus:border-primary-200" />
                                                        <textarea value={manualContent} onChange={(e) => setManualContent(e.target.value)} placeholder="내용을 입력하세요..." className="w-full p-3 bg-slate-50 rounded-xl mb-4 text-sm h-32 resize-none outline-none border border-transparent focus:bg-white focus:border-primary-200"></textarea>
                                                        <button onClick={handleAddManual} className="w-full py-3 bg-slate-800 text-white rounded-xl text-sm font-bold hover:bg-slate-900 transition">텍스트 등록</button>
                                                    </div>
                                                    
                                                    <div className="bg-gradient-to-br from-primary-500 to-accent-600 p-6 rounded-3xl shadow-lg shadow-primary-500/30 text-white text-center">
                                                        <Icon name="file-up" className="w-8 h-8 mx-auto mb-3 opacity-80" />
                                                        <h3 className="font-bold mb-1">PDF 파일 업로드</h3>
                                                        <p className="text-xs text-white/70 mb-4">파일의 텍스트를 자동으로 추출합니다.</p>
                                                        <label className={`block w-full py-3 bg-white/20 backdrop-blur-sm rounded-xl text-sm font-bold cursor-pointer hover:bg-white/30 transition border border-white/30 ${isUploading ? 'opacity-50' : ''}`}>
                                                            {isUploading ? '분석 중...' : '파일 선택'}
                                                            <input type="file" className="hidden" accept="application/pdf" onChange={handleFileUpload} disabled={isUploading} />
                                                        </label>
                                                    </div>
                                                </div>

                                                <div className="lg:col-span-2 overflow-y-auto pr-2">
                                                    <h3 className="font-bold text-slate-800 mb-4 flex items-center"><Icon name="library" className="w-4 h-4 mr-2" /> 등록된 지식 데이터 ({knowledgeItems.length})</h3>
                                                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                                        {knowledgeItems.map((item) => (
                                                            <div key={item.id} className="bg-white p-5 rounded-2xl border border-slate-100 shadow-sm hover:shadow-md transition group relative overflow-hidden">
                                                                <div className={`absolute top-0 left-0 w-1 h-full ${item.type === 'pdf' ? 'bg-red-400' : 'bg-blue-400'}`}></div>
                                                                <div className="flex justify-between items-start mb-2 pl-3">
                                                                    <span className={`text-[10px] px-2 py-1 rounded-md font-bold uppercase tracking-wider ${item.type === 'pdf' ? 'bg-red-50 text-red-600' : 'bg-blue-50 text-blue-600'}`}>{item.type}</span>
                                                                    <button onClick={() => { if(confirm('정말 삭제하시겠습니까?')) onDeleteKnowledge(item.id); }} className="text-slate-300 hover:text-red-500 transition"><Icon name="trash-2" className="w-4 h-4" /></button>
                                                                </div>
                                                                <h4 className="font-bold text-slate-800 text-sm mb-2 truncate pl-3">{item.title}</h4>
                                                                <p className="text-xs text-slate-500 line-clamp-3 pl-3 leading-relaxed">{item.content}</p>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            </div>
                                        )}

                                        {activeTab === 'logs' && (
                                            <div className="bg-white p-8 rounded-3xl border border-slate-100 shadow-sm animate-fade-in h-full flex flex-col">
                                                <div className="flex justify-between items-center mb-6">
                                                    <h3 className="font-bold text-slate-800">대화 이력 모니터링</h3>
                                                    <button onClick={downloadCSV} className="flex items-center gap-2 bg-green-500 text-white px-4 py-2 rounded-xl hover:bg-green-600 transition text-sm font-bold shadow-lg shadow-green-500/20">
                                                        <Icon name="download" className="w-4 h-4" /> CSV 다운로드
                                                    </button>
                                                </div>
                                                <div className="flex-1 overflow-y-auto rounded-xl border border-slate-100">
                                                    <table className="w-full text-left text-sm">
                                                        <thead className="bg-slate-50 text-slate-500 font-bold sticky top-0">
                                                            <tr>
                                                                <th className="px-6 py-4">시간</th>
                                                                <th className="px-6 py-4">질문</th>
                                                                <th className="px-6 py-4">답변</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody className="divide-y divide-slate-50">
                                                            {logs.map(log => (
                                                                <tr key={log.id} className="hover:bg-slate-50/50 transition">
                                                                    <td className="px-6 py-4 text-slate-400 whitespace-nowrap text-xs">{log.displayTimestamp}</td>
                                                                    <td className="px-6 py-4 max-w-xs truncate font-medium text-slate-700">{log.question}</td>
                                                                    <td className="px-6 py-4 max-w-xs truncate text-slate-500">{log.answer}</td>
                                                                </tr>
                                                            ))}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        )}

                                        {activeTab === 'analysis' && (
                                            <div className="animate-fade-in h-full">
                                                <LogAnalysisChart logs={logs} />
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = React.useState(null);
            const [isChatOpen, setIsChatOpen] = React.useState(false);
            const [isAdminOpen, setIsAdminOpen] = React.useState(false);
            const [globalApiKey, setGlobalApiKey] = React.useState("");
            const [globalModelName, setGlobalModelName] = React.useState("gemini-1.5-flash");
            const [knowledgeItems, setKnowledgeItems] = React.useState([]);
            
            const { signInAnonymously, onAuthStateChanged, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc, serverTimestamp, getDoc } = window.firebaseImports;
            const auth = window.auth;
            const db = window.db;

            React.useEffect(() => {
                const unsubscribeAuth = onAuthStateChanged(auth, async (currentUser) => {
                    if (currentUser) {
                        setUser(currentUser);
                        
                        try {
                            const configDoc = await getDoc(doc(db, "settings", "api_config"));
                            if (configDoc.exists()) {
                                const data = configDoc.data();
                                if (data.apiKey) {
                                    setGlobalApiKey(data.apiKey);
                                    setGlobalModelName(data.modelName || "gemini-1.5-flash");
                                }
                            }
                        } catch (err) { console.error(err); }

                        const q = query(collection(db, "knowledge_items"), orderBy("createdAt", "desc"));
                        const unsubscribeData = onSnapshot(q, (snap) => setKnowledgeItems(snap.docs.map(d => ({ id: d.id, ...d.data() }))));
                        return () => unsubscribeData();
                    } else { signInAnonymously(auth).catch(console.error); }
                });
                return () => unsubscribeAuth();
            }, []);

            const handleAddKnowledge = async (item) => { try { await addDoc(collection(db, "knowledge_items"), { ...item, createdAt: serverTimestamp() }); } catch (err) { alert(err.message); } };
            const handleDeleteKnowledge = async (id) => { try { await deleteDoc(doc(db, "knowledge_items", id)); } catch (err) { alert(err.message); } };

            if (!user) return <div className="h-screen flex items-center justify-center"><LoadingSpinner/></div>;

            return (
                <div className="relative">
                    {!isChatOpen && !isAdminOpen && (
                        <div className="fixed bottom-8 right-8 z-50 animate-float">
                            <button onClick={() => setIsChatOpen(true)} className="group relative flex items-center justify-center w-16 h-16 rounded-full shadow-glow transition-all duration-300 bg-gradient-to-r from-primary-600 to-accent-600 hover:scale-110">
                                <Icon name="message-circle" className="w-8 h-8 text-white" />
                                <span className="absolute top-0 right-0 flex h-4 w-4">
                                  <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-accent-400 opacity-75"></span>
                                  <span className={`relative inline-flex rounded-full h-4 w-4 border-2 border-white ${globalApiKey ? 'bg-green-400' : 'bg-red-400'}`}></span>
                                </span>
                            </button>
                        </div>
                    )}
                    {isChatOpen && <ChatWidget user={user} globalApiKey={globalApiKey} globalModelName={globalModelName} knowledgeItems={knowledgeItems} onClose={() => setIsChatOpen(false)} onOpenAdmin={() => setIsAdminOpen(true)} />}
                    {isAdminOpen && <AdminOverlay currentKey={globalApiKey} knowledgeItems={knowledgeItems} onClose={() => setIsAdminOpen(false)} onSetGlobalKey={(k, m) => { setGlobalApiKey(k); setGlobalModelName(m); }} onAddKnowledge={handleAddKnowledge} onDeleteKnowledge={handleDeleteKnowledge} />}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ErrorBoundary><App /></ErrorBoundary>);
    </script>
</body>
</html>